# 低秩定向加速：动机、方法与实验设计（精炼版）

## Background（动机背景）

- 许多模型训练呈现低本征维：最终权重增量可被少数低秩原子近似；微调方法（如 LoRA）验证了“少数方向足够有效”。
- 同时，训练过程常出现稳定的主方向（主奇异向量/子空间变化小），而一步更新若更各向同性会更快收敛。
- 据此，我们希望：优先沿少数有效方向快速放大学习幅度，又保留全秩通道以维持表达力与最终上限。

## Core Idea（核心想法）

在每个“大矩阵层”加入低秩加法分支并只给“幅度参数”更大 LR，其余参数照常训练、并做谱上限以确保稳定；进一步用训练中检测到的稳定主子空间做定向放大 LR 或 warm-up 抽离后放大，以降低 time-to-X。

## Experiments（三+一组关键实验）

统一设置（推荐）：ViT-S / CIFAR-100（输入 resize 到 224），LoRA 插在 q/k/v/o 与 MLP up/down，rank=4/8；优化器 AdamW，LoRA“幅度”用 ×10 LR、不做 WD，对分支做 σ_max clamp ≈ 0.7/√d_in；记录 time-to-85/90%、最终 top-1、稳定性（爆炸率/最大奇异值轨迹）。种子≥3。

1. #1 随机主干冻结 + 只训 LoRA
   - 目的：对比“全秩随机特征+低秩校正” vs 纯低秩网络的表达力与收敛速度。
   - 判读：若起步更慢但最终更高→全秩背景提升上限；若与 #2 重合→当前 LoRA 容量已足够（见下“应对”）。

2. #2 只有 LoRA（主干权重为 0）
   - 目的：给出“纯低秩容量”的速度/上限基线。
   - 预期：起步快、上限低于 #1；若重合，降 rank 或减少插位以拉开差异。

3. #3 训练中追踪“稳定方向”并验证其可用性
   - 做法：每 N 步对各大矩阵的梯度动量矩阵做 top-k SVD，记录奇异值与主向量主角度变化；计算投影能量比 p_t=||U^T G V||_F^2/||G||_F^2。
   - 判读：若出现长期稳定的 top-k 方向且 p_t 不小，说明存在“幸运方向”。
   - 3B（可选实证）：对稳定子空间投影的梯度乘以系数 α>1（仅在该子空间放大学习率），比较 time-to-X 改善。

4. E4 Warm-up 抽离 + 定向大 LR（公平对照“彩票效应”）
   - 做法：warm-up 若干步 → 对每个大矩阵做 top-k 截断 SVD，重参为 W=R+U C V^T（以保持函数等价起点），对 C 用 ×5–10 LR，并将 R 的梯度投到正交补避免“双计数”。
   - 对照：B0（不抽离）、B1（整层全局放大 LR）、B2（随机子空间抽离）、B3（LoRA-only）。
   - 预期：E4 显著降低 time-to-X（10–20%）且最终精度持平；B1 不稳或收益小；B2 无效→证明“数据驱动的方向”才有效。

## Success Criteria（判定标准）

- Speed：相对基线 time-to-X 明显下降（≥10%）。
- Final：最终精度与基线持平或更好（≤0.2pt 差）。
- Stability：最大奇异值受控、无额外爆炸。
- Mechanism：稳定子空间存在且其能量占比/对齐度与加速正相关。
- Ablation：降 rank/减插位能放大 #1 vs #2 的差异；随机子空间（B2）无效，全局放大（B1）不如定向放大（E4）。

## If #1 ≈ #2（两曲线重合时的应对）

- 降 rank（4）、减少插位（仅 MLP up/down 或仅 qkv），或提高任务难度；
- 对 LoRA 分支保留谱上限，避免其完全淹没随机主干；
- 直接上 E4（warm-up 抽离 + 定向大 LR）：通常能拉开差距并验证“先找方向→定向放大”的核心动机。

> 一句话：我们要用 #1/#2 验证“全秩背景+低秩校正”的上限优势，用 #3 证明稳定/幸运方向客观存在并可被利用，再用 E4 把该方向转化为更快的收敛（不牺牲最终精度）。

---

## 实用说明：监控与记录（W&B）

为支撑上述机理验证与稳定性分析，本仓库提供“权重谱监控”与 W&B 记录：

- 每 N 次参数更新，针对指定“大矩阵层”（如 `attn.qkv`, `attn.proj`, `mlp.fc1`, `mlp.fc2`）执行 top-k SVD：
  - 记录最大奇异值与前 k 个奇异值；
  - 记录与上一次监测的主子空间主余弦（U/V 子空间，逐项与汇总 max/mean）；
  - 记录奇异值相对变化（如 ||s_t − s_{t−1}||/||s_{t−1}||）。
- 所有指标将通过 W&B `wandb.log` 输出，便于绘制“最大奇异值轨迹/主角度随时间”等曲线；若未启用 W&B，则写入标准日志。

CLI（拟）：

- `--spec-monitor`：开启谱监控；
- `--spec-every 100`：每 100 次更新计算一次；
- `--spec-topk 8`：取前 k 个奇异向量/值；
- `--spec-targets attn.qkv,attn.proj,mlp.fc1,mlp.fc2`：监控的模块名匹配列表；
- 默认记录主余弦（0–1），输出逐项 `cos_u1..cos_uk` 与 `cos_v1..cos_vk` 以及 `cos_u_max/mean`, `cos_v_max/mean`。
- W&B：沿用 `--log-wandb`、`--wandb-project` 等既有参数，无需额外配置。

日志字段（示例）：

- `spec/<mod>/sigma_max`，`spec/<mod>/sv[1..k]`
- `spec/<mod>/delta_sv_rel`
- `spec/<mod>/cos_u1..k`，`spec/<mod>/cos_v1..k`
- `spec/<mod>/cos_u_max`, `spec/<mod>/cos_u_mean`
- `spec/<mod>/cos_v_max`, `spec/<mod>/cos_v_mean`

这些度量用于：

- Stability：`sigma_max` 是否受控；
- Mechanism：主子空间是否稳定（主角度小），其能量与收敛速度是否相关；
- 与 E4/定向放大实验联动的前后对比。
